(function(){var a=this,b=function(a){if(!a||!a.canvas||!a.path)throw"ImgZoom constructor: missing arguments canvas or path";var b=this;this.canvas=a.canvas,this.canvas.width=this.canvas.clientWidth,this.canvas.height=this.canvas.clientHeight,this.context=this.canvas.getContext("2d"),this.desktop=a.desktop||!1,this.position={x:0,y:0},this.scale={x:1,y:1},this.imgTexture=new Image,this.imgTexture.src=a.path,this.imgTexture.onload=function(){b.originalWidth=b.imgTexture.width,b.originalHeight=b.imgTexture.height},this.lastZoomScale=null,this.lastX=null,this.lastY=null,this.mdown=!1,this.init=!1,this.checkRequestAnimationFrame(),requestAnimationFrame(this.animate.bind(this)),this.setEventListeners()};b.prototype={animate:function(){if(!this.detached){if(!this.init,this.originalWidth){if(this.canvas.height>this.originalHeight){var a=this.canvas.height/this.originalHeight;this.scale.y=a,this.scale.x=a}if(this.canvas.width>this.originalWidth){var a=this.canvas.width/this.originalWidth;a>this.scale.x&&(this.scale.x=a,this.scale.y=a)}}else this.originalWidth=this.imgTexture.width,this.originalHeight=this.imgTexture.height;this.context.clearRect(0,0,this.canvas.width,this.canvas.height),this.context.drawImage(this.imgTexture,this.position.x,this.position.y,this.scale.x*this.imgTexture.width,this.scale.y*this.imgTexture.height),requestAnimationFrame(this.animate.bind(this))}},remove:function(){this.detached=!0},gesturePinchZoom:function(a){var b=!1;if(a.targetTouches.length>=2){var c=a.targetTouches[0],d=a.targetTouches[1],e=Math.sqrt(Math.pow(d.pageX-c.pageX,2)+Math.pow(d.pageY-c.pageY,2));this.lastZoomScale&&(b=e-this.lastZoomScale),this.lastZoomScale=e}return b},doZoom:function(a){if(a){var b=this.scale.x,c=this.scale.x+a/100,d=c-b,e=this.imgTexture.width*this.scale.x,f=this.imgTexture.height*this.scale.y,g=this.imgTexture.width*d,h=this.imgTexture.height*d,i=this.canvas.clientWidth/2,j=this.canvas.clientHeight/2,k=-this.position.x+i,l=-this.position.y+j,m=-k/e,n=-l/f,o=this.position.x+g*m,p=this.position.y+h*n,q=e+g,r=f+h;q<this.canvas.clientWidth||(o>0&&(o=0),o+q<this.canvas.clientWidth&&(o=this.canvas.clientWidth-q),r<this.canvas.clientHeight||(p>0&&(p=0),p+r<this.canvas.clientHeight&&(p=this.canvas.clientHeight-r),this.scale.x=c,this.scale.y=c,this.position.x=o,this.position.y=p))}},doMove:function(a,b){if(this.lastX&&this.lastY){var c=a-this.lastX,d=b-this.lastY,e=this.imgTexture.width*this.scale.x,f=this.imgTexture.height*this.scale.y;this.position.x+=c,this.position.y+=d,this.position.x>0?this.position.x=0:this.position.x+e<this.canvas.clientWidth&&(this.position.x=this.canvas.clientWidth-e),this.position.y>0?this.position.y=0:this.position.y+f<this.canvas.clientHeight&&(this.position.y=this.canvas.clientHeight-f)}this.lastX=a,this.lastY=b},setEventListeners:function(){this.canvas.addEventListener("touchstart",function(){this.lastX=null,this.lastY=null,this.lastZoomScale=null}.bind(this)),this.canvas.addEventListener("touchmove",function(a){if(a.preventDefault(),2==a.targetTouches.length)this.doZoom(this.gesturePinchZoom(a));else if(1==a.targetTouches.length){var b=a.targetTouches[0].pageX-this.canvas.getBoundingClientRect().left,c=a.targetTouches[0].pageY-this.canvas.getBoundingClientRect().top;this.doMove(b,c)}}.bind(this)),this.desktop&&(window.addEventListener("keyup",function(a){187==a.keyCode||61==a.keyCode?this.doZoom(5):54==a.keyCode&&this.doZoom(-5)}.bind(this)),window.addEventListener("mousedown",function(){this.mdown=!0,this.lastX=null,this.lastY=null}.bind(this)),window.addEventListener("mouseup",function(){this.mdown=!1}.bind(this)),window.addEventListener("mousemove",function(a){var b=a.pageX-this.canvas.getBoundingClientRect().left,c=a.pageY-this.canvas.getBoundingClientRect().top;a.target==this.canvas&&this.mdown&&this.doMove(b,c),(0>=b||b>=this.canvas.clientWidth||0>=c||c>=this.canvas.clientHeight)&&(this.mdown=!1)}.bind(this)))},checkRequestAnimationFrame:function(){for(var a=0,b=["ms","moz","webkit","o"],c=0;c<b.length&&!window.requestAnimationFrame;++c)window.requestAnimationFrame=window[b[c]+"RequestAnimationFrame"],window.cancelAnimationFrame=window[b[c]+"CancelAnimationFrame"]||window[b[c]+"CancelRequestAnimationFrame"];window.requestAnimationFrame||(window.requestAnimationFrame=function(b){var c=(new Date).getTime(),d=Math.max(0,16-(c-a)),e=window.setTimeout(function(){b(c+d)},d);return a=c+d,e}),window.cancelAnimationFrame||(window.cancelAnimationFrame=function(a){clearTimeout(a)})}},a.ImgTouchCanvas=b}).call(this);